<!DOCTYPE html>
<html>
	<head>
		<style type="text/css">
			* { margin: 0px; padding: 0px; box-sizing: border-box; }

			html, body, #root { height: 100%; }

			body { background-color: #fff; }
			body.dark { background-color: #171717; }

			body.align1 { text-align: center; }
			body.align2 { text-align: right; }

			body:not(.isTwitter):not(.isReddit) {
				iframe { width: 100% !important; height: 100% !important; border: 0px !important; }
			}

			.twitter-tweet { margin: 0px !important; display: inline-flex !important; }

			body.align1 .twitter-tweet { justify-content: center; }
			body.align2 .twitter-tweet { justify-content: flex-end; }
		</style>
	</head>
	<body>
		<div id="root"></div>
		<div id="scripts"></div>

		<script type="text/javascript">
			let cachedHtml = '';
			let scrollHeight = 0;

			const param = getParam();
			const body = document.body;
			const root = document.getElementById('root');
			const scripts = document.getElementById('scripts');
			const allowedOrigins = [
				'//localhost:',
				'file://',
			];

			window.addEventListener('message', e => {
				if (!allowedOrigins.some(it => e.origin.match(it))) {
					return;
				};

				const { html, js, libs, className, allowResize, align, processor } = e.data;
				const insertBeforeLoad = [ 9, 11 ].includes(processor);

				scripts.innerHTML = '';
				body.className = '';

				if (param.theme) {
					body.classList.add(param.theme);
				};
				if (className) {
					body.classList.add(className);
				};
				body.classList.add(`align${align}`);

				if (insertBeforeLoad) {
					insertHtml(html);
				};

				loadLibs(libs, () => {
					if (!insertBeforeLoad) {
						insertHtml(html);
					};

					if (js) {
						try {
							eval(js);
						} catch (e) {
							console.error(e);
						};
					};

					resize();
					if (allowResize) {
						setInterval(resize, 500);
					};
				});
			});

			window.addEventListener('resize', resize);

			window.onerror = function (message, url, lineNumber) {  
				return true;
			};

			function resize () {
				window.parent.postMessage({ height: document.documentElement.scrollHeight }, '*');
			};

			function insertHtml (html) {
				if (cachedHtml !== html) {
					root.innerHTML = html;
					cachedHtml = html;
				};
			};

			function loadLibs (list, callBack) {
				if (!list.length) {
					if (callBack) {
						callBack();
					};
					return;
				};

				const src = list.shift();
				const script = document.createElement('script');

				scripts.appendChild(script);

				script.onload = function (e) {
					if (list.length) {
						loadLibs(list, callBack);
					} else 
					if (callBack) {
						callBack();
					};
				};

				script.type = 'text/javascript';
				script.src = src;
			};

			function getParam () {
				const a = location.search.replace(/^\?/, '').split('&');
				const param = {};

				a.forEach((s) => {
					const kv = s.split('=');
					param[kv[0]] = kv[1];
				});
				return param;
			};
		</script>
	</body>
</html>