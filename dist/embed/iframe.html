<!DOCTYPE html>
<html>
	<head>
		<script src="../js/jquery.js"></script>
		<style type="text/css">
			* { margin: 0px; padding: 0px; box-sizing: border-box; }

			body { background-color: #fff; }
			body.dark { background-color: #171717; }

			body.align1 { text-align: center; }
			body.align2 { text-align: right; }

			body:not(.allowResize) {
				iframe { width: 100% !important; height: 100% !important; border: 0px !important; }
			}

			#root { font-size: 0px; }

			.twitter-tweet { margin: 0px !important; display: inline-flex !important; }

			body.align1 .twitter-tweet { justify-content: center; }
			body.align2 .twitter-tweet { justify-content: flex-end; }
		</style>
	</head>
	<body>
		<div id="root"></div>
		<div id="scripts"></div>

		<script type="text/javascript">
			$(() => {
				const win = $(window);
				const body = $('body');
				const root = $('#root');
				const scripts = $('#scripts');
				const param = getParam();
				const allowedOrigins = [
					'//localhost:',
					'file://',
				];

				let cachedHtml = '';
				let height = 0;
				let blockId = '';

				win.off('message resize');

				win.on('message', e => {
					const oe = e.originalEvent;
					if (!allowedOrigins.some(it => oe.origin.match(it))) {
						return;
					};

					const { html, js, libs, className, allowResize, align, processor } = oe.data;
					const insertBeforeLoad = [ 9, 11 ].includes(processor);

					blockId = oe.data.blockId;
					scripts.html('');

					if (param.theme) {
						body.addClass(param.theme);
					};
					if (className) {
						body.addClass(className);
					};
					if (allowResize) {
						body.addClass('allowResize');
					};
					body.addClass(`align${align}`);

					if (insertBeforeLoad) {
						insertHtml(html);
					};

					loadLibs(libs, () => {
						if (!insertBeforeLoad) {
							insertHtml(html);
						};

						if (js) {
							try {
								eval(js);
							} catch (e) {
								console.error(e);
							};
						};

						resize();
						if (allowResize) {
							setInterval(resize, 500);
						};
					});
				});

				win.on('resize', resize);

				function resize () {
					window.parent.postMessage({ height: document.documentElement.scrollHeight, blockId }, '*');
				};

				function insertHtml (html) {
					if (cachedHtml !== html) {
						root.html(html);
						cachedHtml = html;
					};
				};

				function loadLibs (list, callBack) {
					if (!list.length) {
						if (callBack) {
							callBack();
						};
						return;
					};

					const src = list.shift();
					const script = document.createElement('script');

					scripts.append(script);

					script.onload = function (e) {
						if (list.length) {
							loadLibs(list, callBack);
						} else 
						if (callBack) {
							callBack();
						};
					};

					script.type = 'text/javascript';
					script.src = src;
				};

				function getParam () {
					const a = location.search.replace(/^\?/, '').split('&');
					const param = {};

					a.forEach((s) => {
						const kv = s.split('=');
						param[kv[0]] = kv[1];
					});
					return param;
				};
			});
		</script>
	</body>
</html>